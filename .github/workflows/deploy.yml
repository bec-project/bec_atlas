name: Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      BEC_CORE_BRANCH:
        description: 'Branch of BEC Core to install'
        required: false
        type: string
      BEC_ATLAS_BRANCH:
        description: 'Branch of BEC Atlas to install'
        required: false
        type: string
      ATLAS_SERVER:
        description: 'The hostname of the atlas server'
        required: true
        default: 'bec-atlas-qa.psi.ch'
        type: choice
        options:
          - bec-atlas-dev.psi.ch
          - bec-atlas-qa.psi.ch

# default: least privileged permissions across all jobs
permissions:
  contents: read



jobs:
  release:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-release-${{ github.ref_name }}
      cancel-in-progress: false

    steps:
      - name: Run deployment
        shell: bash
        run: |
          # Use inputs if available (workflow_dispatch), otherwise use defaults for push
          ATLAS_SERVER="${{ inputs.ATLAS_SERVER || 'bec-atlas-qa.psi.ch' }}"
          ATLAS_BRANCH="${{ inputs.BEC_ATLAS_BRANCH || 'main' }}"
          CORE_BRANCH="${{ inputs.BEC_CORE_BRANCH || 'main' }}"
          
          echo "Deploying application to ${ATLAS_SERVER} environment..."
          curl -X 'POST' \
          "https://gitea.psi.ch/api/v1/repos/bec/ansible_bec/actions/workflows/deploy_bec_atlas.yaml/dispatches?token=${{ secrets.CI_DEPLOY_GITEA }}" \
          -H 'accept: application/json' \
          -H 'Content-Type: application/json' \
          -d "{
          \"inputs\": {
              \"ATLAS_SERVER\": \"${ATLAS_SERVER}\",
              \"BEC_ATLAS_BRANCH\": \"${ATLAS_BRANCH}\",
              \"BEC_CORE_BRANCH\": \"${CORE_BRANCH}\"
          },
          \"ref\": \"refs/heads/main\"
          }"