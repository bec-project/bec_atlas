name: Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      BEC_CORE_BRANCH:
        description: 'Branch of BEC Core to install'
        required: false
        type: string
      BEC_ATLAS_BRANCH:
        description: 'Branch of BEC Atlas to install'
        required: false
        type: string
      DEPLOYMENT_ENV:
        description: 'Deployment environment'
        required: false
        default: 'qa'
        type: choice
        options:
          - dev
          - qa
          - prod

# default: least privileged permissions across all jobs
permissions:
  contents: read



jobs:
  release:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-release-${{ github.ref_name }}
      cancel-in-progress: false

    steps:
      - name: Run deployment
        shell: bash
        run: |
          # Use inputs if available (workflow_dispatch), otherwise use defaults for push
          DEPLOYMENT_ENV="${{ inputs.DEPLOYMENT_ENV || 'qa' }}"
          BEC_ATLAS_BRANCH="${{ inputs.BEC_ATLAS_BRANCH || 'main' }}"
          BEC_CORE_BRANCH="${{ inputs.BEC_CORE_BRANCH || 'main' }}"

          echo "Deploying application to ${DEPLOYMENT_ENV} environment..."
          curl -X 'POST' \
          "https://gitea.psi.ch/api/v1/repos/bec/ansible_bec/actions/workflows/bec_atlas_workflow.yaml/dispatches?token=${{ secrets.CI_DEPLOY_GITEA }}" \
          -H 'accept: application/json' \
          -H 'Content-Type: application/json' \
          -d "{
          \"inputs\": {
              \"DEPLOYMENT_ENV\": \"${DEPLOYMENT_ENV}\",
              \"BEC_ATLAS_BRANCH\": \"${BEC_ATLAS_BRANCH}\",
              \"BEC_CORE_BRANCH\": \"${BEC_CORE_BRANCH}\"
          },
          \"ref\": \"refs/heads/main\"
          }"